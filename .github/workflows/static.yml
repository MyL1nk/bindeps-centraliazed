name: Deploy Static Binary Hosting

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate Index and Prepare Files
        shell: python
        run: |
          import os
          import json
          import shutil
          import fnmatch
          from datetime import datetime

          # 1. Load config
          with open('config.json', 'r') as f:
              config = json.load(f)

          excluded_patterns = config.get('excluded', [])
          metadata = config.get('metadata', {})

          # 2. Tạo cấu trúc thư mục staging
          # Chúng ta sẽ gom hết vào thư mục 'dist'
          dist_dir = 'dist'
          files_dir = os.path.join(dist_dir, 'files')
          os.makedirs(files_dir, exist_ok=True)

          # 3. Quét files và lọc
          included_files = []
          for root, dirs, files in os.walk('.'):
              # Không quét vào thư mục dist hoặc .git
              if 'dist' in root or '.git' in root:
                  continue
              
              for filename in files:
                  filepath = os.path.relpath(os.path.join(root, filename), '.')
                  
                  # Check exclusion
                  is_excluded = False
                  for pattern in excluded_patterns:
                      if fnmatch.fnmatch(filepath, pattern):
                          is_excluded = True
                          break
                  
                  if not is_excluded:
                      stats = os.stat(filepath)
                      file_info = {
                          "name": filename,
                          "path": f"files/{filename}",
                          "size": f"{stats.st_size / 1024:.2f} KB",
                          "modified": datetime.fromtimestamp(stats.st_mtime).strftime('%Y-%m-%d %H:%M:%S'),
                          "meta": metadata.get(filename, {"version": "-", "note": "-", "description": "-"})
                      }
                      included_files.append(file_info)
                      # Copy vào thư mục files để host
                      shutil.copy2(filepath, os.path.join(files_dir, filename))

          # 4. Generate HTML (Minimalist)
          html_content = f"""
          <!DOCTYPE html>
          <html>
          <head>
              <title>Binary Hosting Service</title>
              <meta charset="utf-8">
              <style>
                  body {{ font-family: sans-serif; margin: 40px; background: #f4f4f9; }}
                  table {{ width: 100%; border-collapse: collapse; background: white; }}
                  th, td {{ padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }}
                  th {{ background-color: #24292e; color: white; }}
                  tr:hover {{ background-color: #f5f5f5; }}
                  .download-btn {{ text-decoration: none; background: #2da44e; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }}
              </style>
          </head>
          <body>
              <h2>ORG Binary Repository</h2>
              <p>Last updated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
              <table>
                  <thead>
                      <tr>
                          <th>Filename</th>
                          <th>Version</th>
                          <th>Size</th>
                          <th>Modified</th>
                          <th>Description</th>
                          <th>Action</th>
                      </tr>
                  </thead>
                  <tbody>
          """

          for f in included_files:
              html_content += f"""
                      <tr>
                          <td><strong>{f['name']}</strong></td>
                          <td><code>{f['meta']['version']}</code></td>
                          <td>{f['size']}</td>
                          <td>{f['modified']}</td>
                          <td><i>{f['meta']['description']}</i><br><small>{f['meta']['note']}</small></td>
                          <td><a class="download-btn" href="{f['path']}">Download</a></td>
                      </tr>
              """

          html_content += """
                  </tbody>
              </table>
          </body>
          </html>
          """

          with open(os.path.join(dist_dir, 'index.html'), 'w') as f:
              f.write(html_content)

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Chỉ upload thư mục dist đã được build sạch sẽ
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
